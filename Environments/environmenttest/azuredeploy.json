{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "4.0.0.0",
    "metadata": {
      "description": "Deploy DCLab",
      "author": "Joel Stephens"
    },
    "parameters": {
     
      "addPublicIPAddress": {
        "type": "string",
        "defaultValue": "Yes",
        "allowedValues": [
          "Yes",
          "No",
          "SharePointVMsOnly"
        ],
        "metadata": {
          "description": "Specify if each VM should have a public IP and be reachable from Internet."
        }
      },
      "RDPTrafficAllowed": {
        "type": "string",
        "defaultValue": "Yes",
        "minLength": 1,
        "metadata": {
          "description": "Specify if RDP traffic is allowed:<br>- If 'No' (default): Firewall denies all incoming RDP traffic.<br>- If '*' or 'Internet': Firewall accepts all incoming RDP traffic from Internet.<br>- If CIDR notation (e.g. 192.168.99.0/24 or 2001:1234::/64) or IP address (e.g. 192.168.99.0 or 2001:1234::): Firewall accepts incoming RDP traffic from the IP addresses specified."
        }
      },
      "adminUserName": {
        "type": "string",
        "minLength": 1,
        "metadata": {
          "description": "Name of the AD and SharePoint administrator. 'admin' and 'administrator' are not allowed."
        }
      },
      "adminPassword": {
        "type": "securestring",
        "minLength": 8,
        "metadata": {
          "description": "Input must meet password complexity requirements as documented in https://learn.microsoft.com/azure/virtual-machines/windows/faq#what-are-the-password-requirements-when-creating-a-vm-"
        }
      },
      "vmsTimeZone": {
        "type": "string",
        "defaultValue": "Pacific Standard Time",
        "allowedValues": [
          "Pacific Standard Time"
        ],
        "minLength": 2,
        "metadata": {
          "description": "Time zone of the virtual machines. Type \"[TimeZoneInfo]::GetSystemTimeZones().Id\" in PowerShell to get the list."
        }
      },
      "enableAutomaticUpdates": {
        "type": "bool",
        "defaultValue": true,
        "metadata": {
          "description": "Enable automatic Windows Updates."
        }
      },
      "enableHybridBenefitServerLicenses": {
        "type": "bool",
        "defaultValue": false,
        "metadata": {
          "description": "Enable Azure Hybrid Benefit to use your on-premises Windows Server licenses and reduce cost. See https://docs.microsoft.com/en-us/azure/virtual-machines/windows/hybrid-use-benefit-licensing for more information."
        }
      },
      "vmDCSize": {
        "type": "string",
        "defaultValue": "Standard_B2s",
        "metadata": {
          "description": "Size of the DC VM"
        }
      },
      "vmDCStorageAccountType": {
        "type": "string",
        "defaultValue": "StandardSSD_LRS",
        "allowedValues": [
          "Standard_LRS",
          "StandardSSD_LRS",
          "Premium_LRS",
          "Premium_ZRS",
          "StandardSSD_ZRS",
          "UltraSSD_LRS"
        ],
        "metadata": {
          "description": "Type of storage for the managed disks. Visit 'https://docs.microsoft.com/en-us/rest/api/compute/disks/list#diskstorageaccounttypes' for more information"
        }
      },
      "vmSQLSize": {
        "type": "string",
        "defaultValue": "Standard_B2ms",
        "metadata": {
          "description": "Size of the SQL VM"
        }
      },
      "vmSQLStorageAccountType": {
        "type": "string",
        "defaultValue": "StandardSSD_LRS",
        "allowedValues": [
          "Standard_LRS",
          "StandardSSD_LRS",
          "Premium_LRS",
          "Premium_ZRS",
          "StandardSSD_ZRS",
          "UltraSSD_LRS"
        ],
        "metadata": {
          "description": "Type of storage for the managed disks. Visit 'https://docs.microsoft.com/en-us/rest/api/compute/disks/list#diskstorageaccounttypes' for more information"
        }
      }
    },
    "variables": {
      "location": "[resourceGroup().location]",
      "resourceGroupNameFormatted": "[replace(replace(replace(replace(resourceGroup().name, '.', '-'), '(', '-'), ')', '-'), '_', '-')]",
      "networkSettings": {
        "vNetPrivatePrefix": "10.1.0.0/16",
        "subnetDCPrefix": "10.1.1.0/24",
        "dcPrivateIPAddress": "10.1.1.4",
        "subnetSQLPrefix": "10.1.2.0/24",
        "vNetPrivateName": "[concat(variables('resourceGroupNameFormatted'), '-vnet')]",
        "subnetDCName": "Subnet-DC",
        "subnetSQLName": "Subnet-SQL",
        "nsgSubnetDCName": "NSG-Subnet-DC",
        "nsgSubnetSQLName": "NSG-Subnet-SQL",
        "vmDCPublicIPNicAssociation": {
          "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('vmsResourcesNames').vmDCPublicIPName)]"
        },
        "vmSQLPublicIPNicAssociation": {
          "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('vmsResourcesNames').vmSQLPublicIPName)]"
        },
        "nsgRuleAllowIncomingRdp": [
          {
            "name": "allow-rdp-rule",
            "properties": {
              "description": "Allow RDP",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "3389",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 110,
              "direction": "Inbound"
            }
          }
        ]
      },
      "vmsSettings": {
        "vmDCName": "DC",
        "vmSQLName": "SQL",
        "vmDCImage": "MicrosoftWindowsServer:WindowsServer:2022-datacenter-azure-edition-smalldisk:latest",
        "vmSQLImage": "MicrosoftWindowsServer:WindowsServer:2022-datacenter-azure-edition-smalldisk:latest"
      },
      "vmsResourcesNames": {
        "vmDCNicName": "[concat('NIC-', variables('vmsSettings').vmDCName, '-0')]",
        "vmDCPublicIPName": "[concat('PublicIP-', variables('vmsSettings').vmDCName)]",
        "vmSQLNicName": "[concat('NIC-', variables('vmsSettings').vmSQLName, '-0')]",
        "vmSQLPublicIPName": "[concat('PublicIP-', variables('vmsSettings').vmSQLName)]"
      },
      "deploymentSettings": {
        "localAdminUserName": "[concat('local-', uniqueString(subscription().subscriptionId))]",
        "enableAnalysis": false,
        "applyBrowserPolicies": true
      }
    },
    "resources": [
      {
        "name": "[variables('networkSettings').nsgSubnetDCName]",
        "type": "Microsoft.Network/networkSecurityGroups",
        "apiVersion": "2022-07-01",
        "location": "[variables('location')]",
        "properties": {
          "securityRules": "[if(equals(toLower(parameters('RDPTrafficAllowed')), 'no'), json('null'), variables('networkSettings').nsgRuleAllowIncomingRdp)]"
        }
      },
      {
        "name": "[variables('networkSettings').nsgSubnetSQLName]",
        "type": "Microsoft.Network/networkSecurityGroups",
        "apiVersion": "2022-07-01",
        "location": "[variables('location')]",
        "properties": {
          "securityRules": "[if(equals(toLower(parameters('RDPTrafficAllowed')), 'no'), json('null'), variables('networkSettings').nsgRuleAllowIncomingRdp)]"
        }
      },
      {
        "name": "[variables('networkSettings').vNetPrivateName]",
        "type": "Microsoft.Network/virtualNetworks",
        "apiVersion": "2022-07-01",
        "location": "[variables('location')]",
        "dependsOn": [
          "[resourceId('Microsoft.Network/networkSecurityGroups', variables('networkSettings').nsgSubnetDCName)]",
          "[resourceId('Microsoft.Network/networkSecurityGroups', variables('networkSettings').nsgSubnetSQLName)]"
        ],
        "properties": {
          "addressSpace": {
            "addressPrefixes": [
              "[variables('networkSettings').vNetPrivatePrefix]"
            ]
          },
          "subnets": [
            {
              "name": "[variables('networkSettings').subnetDCName]",
              "properties": {
                "addressPrefix": "[variables('networkSettings').subnetDCPrefix]",
                "networkSecurityGroup": {
                  "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('networkSettings').nsgSubnetDCName)]"
                }
              }
            },
            {
              "name": "[variables('networkSettings').subnetSQLName]",
              "properties": {
                "addressPrefix": "[variables('networkSettings').subnetSQLPrefix]",
                "networkSecurityGroup": {
                  "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('networkSettings').nsgSubnetSQLName)]"
                }
              }
            }
          ]
        }
      },
      {
        "name": "[variables('vmsResourcesNames').vmDCPublicIPName]",
        "type": "Microsoft.Network/publicIPAddresses",
        "apiVersion": "2022-07-01",
        "location": "[variables('location')]",
        "sku": {
          "name": "Basic",
          "tier": "Regional"
        },
        "properties": {
          "publicIPAllocationMethod": "Dynamic",
          "dnsSettings": {
            "domainNameLabel": "[toLower(concat(variables('resourceGroupNameFormatted'), '-', variables('vmsSettings').vmDCName))]"
          }
        }
      },
      {
        "name": "[variables('vmsResourcesNames').vmDCNicName]",
        "type": "Microsoft.Network/networkInterfaces",
        "apiVersion": "2022-07-01",
        "location": "[variables('location')]",
        "dependsOn": [
          "[resourceId('Microsoft.Network/virtualNetworks', variables('networkSettings').vNetPrivateName)]",
          "[resourceId('Microsoft.Network/publicIPAddresses', variables('vmsResourcesNames').vmDCPublicIPName)]"
        ],
        "properties": {
          "ipConfigurations": [
            {
              "name": "ipconfig1",
              "properties": {
                "privateIPAllocationMethod": "Static",
                "privateIPAddress": "[variables('networkSettings').dcPrivateIPAddress]",
                "subnet": {
                  "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('networkSettings').vNetPrivateName, variables('networkSettings').subnetDCName)]"
                },
                "publicIPAddress": "[variables('networkSettings').vmDCPublicIPNicAssociation]"
              }
            }
          ]
        }
      },
      {
        "name": "[variables('vmsSettings').vmDCName]",
        "type": "Microsoft.Compute/virtualMachines",
        "apiVersion": "2022-08-01",
        "location": "[variables('location')]",
        "dependsOn": [
          "[resourceId('Microsoft.Network/networkInterfaces', variables('vmsResourcesNames').vmDCNicName)]"
        ],
        "properties": {
          "hardwareProfile": {
            "vmSize": "[parameters('vmDCSize')]"
          },
          "osProfile": {
            "computerName": "[variables('vmsSettings').vmDCName]",
            "adminUsername": "[parameters('adminUserName')]",
            "adminPassword": "[parameters('adminPassword')]",
            "windowsConfiguration": {
              "timeZone": "[parameters('vmsTimeZone')]",
              "enableAutomaticUpdates": "[parameters('enableAutomaticUpdates')]",
              "provisionVMAgent": true,
              "patchSettings": {
                "patchMode": "[if(parameters('enableAutomaticUpdates'), 'AutomaticByOS', 'Manual')]",
                "assessmentMode": "ImageDefault"
              }
            }
          },
          "storageProfile": {
            "imageReference": {
              "publisher":  "[split(variables('vmsSettings').vmDCImage, ':')[0]]",
              "offer": "[split(variables('vmsSettings').vmDCImage, ':')[1]]",
              "sku":  "[split(variables('vmsSettings').vmDCImage, ':')[2]]",
              "version":  "[split(variables('vmsSettings').vmDCImage, ':')[3]]"
            },
            "osDisk": {
              "name": "[concat('Disk-', variables('vmsSettings').vmDCName, '-OS')]",
              "caching": "ReadWrite",
              "osType": "Windows",
              "createOption": "FromImage",
              "diskSizeGB": 32,
              "managedDisk": {
                "storageAccountType": "[parameters('vmDCStorageAccountType')]"
              }
            }
          },
          "networkProfile": {
            "networkInterfaces": [
              {
                "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('vmsResourcesNames').vmDCNicName)]"
              }
            ]
          },
          "licenseType": "[if(parameters('enableHybridBenefitServerLicenses'), 'Windows_Server', json('null'))]"
        }
      },
      {
        "name": "[variables('vmsResourcesNames').vmSQLPublicIPName]",
        "type": "Microsoft.Network/publicIPAddresses",
        "apiVersion": "2022-07-01",
        "location": "[variables('location')]",
        "sku": {
          "name": "Basic",
          "tier": "Regional"
        },
        "properties": {
          "publicIPAllocationMethod": "Dynamic",
          "dnsSettings": {
            "domainNameLabel": "[toLower(concat(variables('resourceGroupNameFormatted'), '-', variables('vmsSettings').vmSQLName))]"
          }
        }
      },
      {
        "name": "[variables('vmsResourcesNames').vmSQLNicName]",
        "type": "Microsoft.Network/networkInterfaces",
        "apiVersion": "2022-07-01",
        "location": "[variables('location')]",
        "dependsOn": [
          "[resourceId('Microsoft.Network/virtualNetworks', variables('networkSettings').vNetPrivateName)]",
          "[resourceId('Microsoft.Network/publicIPAddresses', variables('vmsResourcesNames').vmSQLPublicIPName)]"
        ],
        "properties": {
          "ipConfigurations": [
            {
              "name": "ipconfig1",
              "properties": {
                "privateIPAllocationMethod": "Dynamic",
                "subnet": {
                  "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('networkSettings').vNetPrivateName, variables('networkSettings').subnetSQLName)]"
                },
                "publicIPAddress": "[variables('networkSettings').vmSQLPublicIPNicAssociation]"
              }
            }
          ]
        }
      },
      {
        "name": "[variables('vmsSettings').vmSQLName]",
        "type": "Microsoft.Compute/virtualMachines",
        "apiVersion": "2022-08-01",
        "location": "[variables('location')]",
        "dependsOn": [
          "[resourceId('Microsoft.Network/networkInterfaces', variables('vmsResourcesNames').vmSQLNicName)]"
        ],
        "properties": {
          "hardwareProfile": {
            "vmSize": "[parameters('vmSQLSize')]"
          },
          "osProfile": {
            "computerName": "[variables('vmsSettings').vmSQLName]",
            "adminUsername": "[variables('deploymentSettings').localAdminUserName]",
            "adminPassword": "[parameters('adminPassword')]",
            "windowsConfiguration": {
              "timeZone": "[parameters('vmsTimeZone')]",
              "enableAutomaticUpdates": "[parameters('enableAutomaticUpdates')]",
              "provisionVMAgent": true,
              "patchSettings": {
                "patchMode": "[if(parameters('enableAutomaticUpdates'), 'AutomaticByOS', 'Manual')]",
                "assessmentMode": "ImageDefault"
              }
            }
          },
          "storageProfile": {
            "imageReference": {
              "publisher":  "[split(variables('vmsSettings').vmSQLImage, ':')[0]]",
              "offer": "[split(variables('vmsSettings').vmSQLImage, ':')[1]]",
              "sku":  "[split(variables('vmsSettings').vmSQLImage, ':')[2]]",
              "version":  "[split(variables('vmsSettings').vmSQLImage, ':')[3]]"
            },
            "osDisk": {
              "name": "[concat('Disk-', variables('vmsSettings').vmSQLName, '-OS')]",
              "caching": "ReadWrite",
              "osType": "Windows",
              "createOption": "FromImage",
              "diskSizeGB": 128,
              "managedDisk": {
                "storageAccountType": "[parameters('vmSQLStorageAccountType')]"
              }
            }
          },
          "networkProfile": {
            "networkInterfaces": [
              {
                "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('vmsResourcesNames').vmSQLNicName)]"
              }
            ]
          },
          "licenseType": "[if(parameters('enableHybridBenefitServerLicenses'), 'Windows_Server', json('null'))]"
        },
        "resources": []
      }
    ],
    "outputs": {
      "publicIPAddressSQL": {
        "type": "string",
        "value": "[reference(resourceId('Microsoft.Network/publicIPAddresses', variables('vmsResourcesNames').vmSQLPublicIPName)).dnsSettings.fqdn]"
      },
      "publicIPAddressDC": {
        "type": "string",
        "value": "[reference(resourceId('Microsoft.Network/publicIPAddresses', variables('vmsResourcesNames').vmDCPublicIPName)).dnsSettings.fqdn]"
      }
    }
  }
